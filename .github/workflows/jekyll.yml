  name: Build and Deploy Jekyll Site

  on:
    push:
      branches: ["main"]
    workflow_dispatch:

  permissions:
    contents: write
    pages: write
    id-token: write

  concurrency:
    group: "pages"
    cancel-in-progress: false

  jobs:
    build:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Setup Ruby
          uses: ruby/setup-ruby@v1
          with:
            ruby-version: '3.3'
            bundler-cache: true

        - name: Install WebP tools
          run: sudo apt-get install -y webp

        - name: Convert new images to WebP
          run: |
            > converted_images.txt
            find assets/images/uploads -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) 2>/dev/null | while read img; do
              webp_file="${img%.*}.webp"
              if [ ! -f "$webp_file" ]; then
                cwebp -q 80 "$img" -o "$webp_file"
                echo "Converted: $img ‚Üí $webp_file"
                basename "$img" >> converted_images.txt
              fi
            done || true

        - name: Update image references in posts
          run: |
            if [ ! -s converted_images.txt ]; then
              echo "No images converted, skipping reference updates"
              exit 0
            fi

            python3 << 'PYTHON_SCRIPT'
            import os
            import re

            # Leggi lista immagini convertite
            with open('converted_images.txt', 'r') as f:
                converted_images = [line.strip() for line in f if line.strip()]

            if not converted_images:
                print("No converted images found")
                exit()

            extensions = ['jpg', 'jpeg', 'png', 'JPG', 'JPEG', 'PNG']
            posts_dir = '_posts'
            updated_files = []

            for filename in os.listdir(posts_dir):
                if not filename.endswith('.md'):
                    continue

                filepath = os.path.join(posts_dir, filename)
                with open(filepath, 'r', encoding='utf-8') as f:
                    content = f.read()

                original_content = content

                for img_name in converted_images:
                    img_base = os.path.splitext(img_name)[0]

                    for ext in extensions:
                        # Pattern 1: Front matter (image: /path/file.ext)
                        pattern1 = re.compile(
                            rf'(image:\s+["\']?[^\s"\']*/{re.escape(img_base)})\.{ext}(["\']?)',
                            re.IGNORECASE
                        )
                        content = pattern1.sub(r'\1.webp\2', content)

                        # Pattern 2: Markdown image (![alt](path/file.ext))
                        pattern2 = re.compile(
                            rf'(\!\[.*?\]\([^\)]*/{re.escape(img_base)})\.{ext}(\))',
                            re.IGNORECASE
                        )
                        content = pattern2.sub(r'\1.webp\2', content)

                        # Pattern 3: HTML img tag (<img src="path/file.ext">)
                        pattern3 = re.compile(
                            rf'(<img[^>]+src=["\'][^\'"]*/{re.escape(img_base)})\.{ext}(["\'][^>]*>)',
                            re.IGNORECASE
                        )
                        content = pattern3.sub(r'\1.webp\2', content)

                        # Pattern 4: Front matter senza slash iniziale
                        pattern4 = re.compile(
                            rf'(image:\s+["\']?)({re.escape(img_base)})\.{ext}(["\']?\s*$)',
                            re.IGNORECASE | re.MULTILINE
                        )
                        content = pattern4.sub(r'\1\2.webp\3', content)

                if content != original_content:
                    with open(filepath, 'w', encoding='utf-8') as f:
                        f.write(content)
                    updated_files.append(filename)
                    print(f"Updated: {filename}")

            if updated_files:
                print(f"\nTotal files updated: {len(updated_files)}")
            else:
                print("No post references needed updating")

            PYTHON_SCRIPT

        - name: Remove original images
          run: |
            find assets/images/uploads -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" \) 2>/dev/null | while read img; do
              webp_file="${img%.*}.webp"
              if [ -f "$webp_file" ]; then
                rm "$img"
                echo "Removed: $img"
              fi
            done || true

        - name: Commit WebP conversions
          run: |
            if [ ! -s converted_images.txt ]; then
              echo "No conversions to commit"
              exit 0
            fi

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A assets/images/uploads/
            git add _posts/*.md

            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              git commit -m "üñºÔ∏è Convert images to WebP and update references [skip ci]"
              git push
              echo "Changes committed and pushed"
            fi

        - name: Setup Pages
          id: pages
          uses: actions/configure-pages@v4

        - name: Build with Jekyll
          run: bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"
          env:
            JEKYLL_ENV: production

        - name: Upload artifact
          uses: actions/upload-pages-artifact@v3

    deploy:
      environment:
        name: github-pages
        url: ${{ steps.deployment.outputs.page_url }}
      runs-on: ubuntu-latest
      needs: build
      steps:
        - name: Deploy to GitHub Pages
          id: deployment
          uses: actions/deploy-pages@v4

